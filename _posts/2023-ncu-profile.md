## Use nsight compute for DRAM profiling 

I use a single warp to load 4 cachelines (128 bytes) of data from global memory to shared memory
```
__shared__ float4 shared[32];
for(int i=WARPLANE; i<32; i=+32)
   shared[WARPLANE] = ((float4 *)ptr)[WARPLANE];
```
Then, we run:
```
TMPDIR=~ ncu --kernel-name test_cta_pip_kernel --metrics memory_l1_tag_requests_global,memory_l2_theoretical_sectors_global,memory_l2_theoretical_sectors_global_ideal,group:memory__dram_table python test.py
```
We expect above code will load 4 cachlines from DRAM to L2, then L1. Therefore, there should be 4 global transactions, with 4 cacheline and 16 sectors. 

Before profiling above code, let's look up each memory profiling metrics:
- memory_l1_tag_requests_global: Number of L1 tag requests generated by global memory instructions.
- memory_l2_theoretical_sectors_global: Theoretical number of sectors requested in L2 from global memory instructions.
- memory_l2_theoretical_sectors_global_ideal: Ideal number of sectors requested in L2 from global memory instructions, assuming each not predicated-off thread performed the operation.

I put them together as all of three metrics need to be use to complete the picture.
Let's try run the below code first:
```
__shared__ float4 shared[32];
if(WARPLANE < 2)
   shared[WARPLANE] = ((float4 *)ptr)[WARPLANE];
```
We got:
```
==PROF== Disconnected from process 2122618
[2122618] python3.11@127.0.0.1
  test_cta_pip_kernel(at::GenericPackedTensorAccessor<float, (unsigned long)4, at::RestrictPtrTraits, int>, float *, int) (1, 1, 1)x(32, 1, 1), Context 1, Stream 7, Device 0, CC 7.0
    Section: Command line profiler metrics
    --------------------------------------------------- ------------ ------------
    Metric Name                                          Metric Unit Metric Value
    --------------------------------------------------- ------------ ------------
    dram__bytes_read.sum                                       Kbyte         1.02
    dram__bytes_read.sum.pct_of_peak_sustained_elapsed             %         0.00
    dram__bytes_read.sum.per_second                     Mbyte/second        10.26
    dram__bytes_write.sum                                       byte            0
    dram__bytes_write.sum.pct_of_peak_sustained_elapsed            %            0
    dram__bytes_write.sum.per_second                     byte/second            0
    dram__sectors_read.sum                                    sector           32
    dram__sectors_write.sum                                   sector            0
    memory_l1_tag_requests_global                            sectors            1
    memory_l2_theoretical_sectors_global                     sectors            1
    memory_l2_theoretical_sectors_global_ideal               sectors            1
    --------------------------------------------------- ------------ ------------
```

```
__shared__ float4 shared[32];
if(WARPLANE < 4)
   shared[WARPLANE] = ((float4 *)ptr)[WARPLANE];
```
We got:
```
==PROF== Disconnected from process 2113630
[2113630] python3.11@127.0.0.1
  test_cta_pip_kernel(at::GenericPackedTensorAccessor<float, (unsigned long)4, at::RestrictPtrTraits, int>, float *, int) (1, 1, 1)x(32, 1, 1), Context 1, Stream 7, Device 0, CC 7.0
    Section: Command line profiler metrics
    --------------------------------------------------- ------------ ------------
    Metric Name                                          Metric Unit Metric Value
    --------------------------------------------------- ------------ ------------
    dram__bytes_read.sum                                       Kbyte         1.02
    dram__bytes_read.sum.pct_of_peak_sustained_elapsed             %         0.00
    dram__bytes_read.sum.per_second                     Mbyte/second        10.33
    dram__bytes_write.sum                                       byte            0
    dram__bytes_write.sum.pct_of_peak_sustained_elapsed            %            0
    dram__bytes_write.sum.per_second                     byte/second            0
    dram__sectors_read.sum                                    sector           32
    dram__sectors_write.sum                                   sector            0
    memory_l1_tag_requests_global                            sectors            1
    memory_l2_theoretical_sectors_global                     sectors            2
    memory_l2_theoretical_sectors_global_ideal               sectors            2
    --------------------------------------------------- ------------ ------------
```
```
__shared__ float4 shared[32];
if(WARPLANE < 8)
   shared[WARPLANE] = ((float4 *)ptr)[WARPLANE];
```
We got:
```
==PROF== Disconnected from process 2104219
[2104219] python3.11@127.0.0.1
  test_cta_pip_kernel(at::GenericPackedTensorAccessor<float, (unsigned long)4, at::RestrictPtrTraits, int>, float *, int) (1, 1, 1)x(32, 1, 1), Context 1, Stream 7, Device 0, CC 7.0
    Section: Command line profiler metrics
    --------------------------------------------------- ------------ ------------
    Metric Name                                          Metric Unit Metric Value
    --------------------------------------------------- ------------ ------------
    dram__bytes_read.sum                                       Kbyte         1.09
    dram__bytes_read.sum.pct_of_peak_sustained_elapsed             %         0.00
    dram__bytes_read.sum.per_second                     Mbyte/second        10.01
    dram__bytes_write.sum                                       byte            0
    dram__bytes_write.sum.pct_of_peak_sustained_elapsed            %            0
    dram__bytes_write.sum.per_second                     byte/second            0
    dram__sectors_read.sum                                    sector           34
    dram__sectors_write.sum                                   sector            0
    memory_l1_tag_requests_global                            sectors            1
    memory_l2_theoretical_sectors_global                     sectors            4
    memory_l2_theoretical_sectors_global_ideal               sectors            4
    --------------------------------------------------- ------------ ------------
```

From above 3 experiments, we can observe that
* `memory_l1_tag_requests_global` gives number of global transactions issued by warps. It is the same of the old metric `gld_transactions` if one is farmilar with deprecated `nvprof`. 
* Each request of a transaction load at least one sector, and at most 4 sectors. Based on one's code, it may have `memory_l2_theoretical_sectors_global_ideal` range from `memory_l1_tag_requests_global` ~ `memory_l1_tag_requests_global*4` as above experiments shows.
* If one's `memory_l2_theoretical_sectors_global` is the same of `memory_l2_theoretical_sectors_global_ideal`, one may have the access partern which is mostly efficient to load from DRAM

Now we profile the code which loads 4 cachelines, we got:
```
==PROF== Disconnected from process 2131341
[2131341] python3.11@127.0.0.1
  test_cta_pip_kernel(at::GenericPackedTensorAccessor<float, (unsigned long)4, at::RestrictPtrTraits, int>, float *, int) (1, 1, 1)x(32, 1, 1), Context 1, Stream 7, Device 0, CC 7.0
    Section: Command line profiler metrics
    --------------------------------------------------- ------------ ------------
    Metric Name                                          Metric Unit Metric Value
    --------------------------------------------------- ------------ ------------
    dram__bytes_read.sum                                       Kbyte         1.47
    dram__bytes_read.sum.pct_of_peak_sustained_elapsed             %         0.00
    dram__bytes_read.sum.per_second                     Mbyte/second        14.81
    dram__bytes_write.sum                                       byte            0
    dram__bytes_write.sum.pct_of_peak_sustained_elapsed            %            0
    dram__bytes_write.sum.per_second                     byte/second            0
    dram__sectors_read.sum                                    sector           46
    dram__sectors_write.sum                                   sector            0
    memory_l1_tag_requests_global                            sectors            4
    memory_l2_theoretical_sectors_global                     sectors           16
    memory_l2_theoretical_sectors_global_ideal               sectors           16
    --------------------------------------------------- ------------ ------------

```
The profile results show that we issue 4 transaction requests and those 4 requests load 16 sectors from the DRAM and it is the most efficient way of loading.

Another useful metric is:
- group:memory__dram_table
It includes 8 metrices:
```
dram__bytes_read.sum                         
dram__bytes_read.sum.pct_of_peak_sustained_elapsed 
dram__bytes_read.sum.per_second                   
dram__bytes_write.sum                            
dram__bytes_write.sum.pct_of_peak_sustained_elapsed
dram__bytes_write.sum.per_second                  
dram__sectors_read.sum                           
dram__sectors_write.sum                         
```
Those metrics are more straightforward and their example can be seen above
